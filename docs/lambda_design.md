# Lambda 設計：キャッシュなしで e-Gov API を叩く最適化戦略

## 目的

- 法令データをローカル保存せず、常に e-Gov 法令 API から最新データを取得する。
- Alexa-hosted (Node.js) の制約（最大実行時間 3 秒）内で処理を完了させる。
- タイムアウトを避けつつ、法令改正への追従性を維持する。

## 前提条件

- ホスティング: Alexa-hosted (Node.js)
- リージョン: 米国西部（オレゴン）
- データ保存: S3 / DynamoDB などの永続キャッシュは使用しない。
- 法令一覧のローカルファイル保存も行わない（メンテナンス負荷回避）。

## 全体フロー

1. Alexa からのリクエストを受け取る（LaunchRequest / IntentRequest）。
2. ユーザの発話から以下を抽出する：
   - 法令名（例: 「民法」「刑法」）
   - 条番号（例: `9`, `199`）
3. e-Gov API `/laws` を呼び出し、法令一覧を取得する。
4. 法令一覧から法令名に対応する `lawId` を検索する。
5. `lawId` を使って `/law/{lawId}` を呼び出し、法令本文（XML）を取得する。
6. XML から指定条番号に対応する `<Article>` を探し、本文を抽出する。
7. 抽出した条文テキストを読み上げ用に整形する。
8. Alexa のレスポンス形式に変換して返す。

## 最適化戦略

### 1. ネットワークレイテンシの最小化

- リージョンは日本に最も近い **米国西部（オレゴン）** を使用する。
- これにより、Lambda ↔ e-Gov API 間の往復時間を最小化する。

### 2. 法令一覧取得の扱い

- `/laws` は毎回 API から取得する（永続キャッシュは持たない）。
- ただし、Lambda の「ウォーム状態」ではメモリが保持されるため、
  実装上は以下のような最適化を許容する：

  - グローバル変数に法令一覧を保持し、同一コンテナ内の後続リクエストでは再利用する。
  - これは永続ストレージではなく、一時的なメモリ再利用であり、
    法令改正のタイミングとの整合性は e-Gov 側に委ねる。

- ただし、本設計では **「キャッシュなし」を原則**とするため、
  実装時にこの最適化を行うかどうかはオプションとする。

### 3. 法令本文取得と XML パース

- `/law/{lawId}` のレスポンスは XML であり、サイズが大きくなる可能性がある。
- Node.js では以下の方針でパースする：
  - シンプルな XML パーサ（例: `xml2js`）を使用する。
  - 必要な部分（`<Article>` と `<ArticleNum>`、`<Paragraph>`）に絞って処理する。
- 条番号のマッチングは以下のように行う：
  - ユーザ入力（例: `9`）を「第九条」「第九条の二」などの表記と対応付けるロジックを実装する。
  - 初期実装では単純な一致（例: `第九条`）から始め、将来的に拡張可能な形にする。

### 4. 読み上げ用整形

- 条文テキストには以下の整形を行う：
  - 不要な改行・連続スペースの削除
  - 読み上げに不要な括弧書きの簡易除去（必要に応じて）
  - 法令用語の読み方補正（例: 「附則」→「ふそく」）
- 読み上げ辞書は Lambda 内にハードコードされたオブジェクトとして持つ。
  - これは頻繁な更新を必要としないため、ローカル保存の問題とは切り離して扱う。

### 5. タイムアウト対策

- 処理全体が 3 秒以内に収まるよう、以下を徹底する：
  - 不要なログ出力を減らす。
  - 並列リクエストは行わず、シンプルな直列処理とする。
  - エラー時は早期にレスポンスを返し、「タイムアウトまで待たない」設計にする。
- e-Gov API のレスポンスが極端に遅い場合は、
  「現在、法令データの取得に時間がかかっています」といったメッセージを返す。

## エラーハンドリング方針

- 法令名が見つからない場合：
  - 「指定された法令が見つかりませんでした。」と返す。
- 条番号が見つからない場合：
  - 「指定された条文が見つかりませんでした。」と返す。
- e-Gov API エラー時：
  - 「現在、法令データにアクセスできません。」と返す。
- 予期しないエラー：
  - 「内部エラーが発生しました。」と返すが、詳細はログにのみ出力する。

## セキュリティと制約

- GitHub 上に秘密情報（API キー、スキル ID 等）は一切含めない。
- Alexa-hosted スキルでは、スキル ID と Lambda の紐付けは
  Alexa Developer Console 側で行うため、コード内にハードコードしない。
- e-Gov API は認証不要の公開 API のみを使用する。
